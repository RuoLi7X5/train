# Phase 2 功能测试指南

## 测试环境
- **URL**: http://localhost:3000
- **测试账号**: ruoli / ruoli （超级管理员）
- **测试日期**: 2026-02-10

---

## 测试清单

### ✅ 1. 草稿箱功能测试

#### 1.1 创建草稿
**步骤**:
1. 登录系统
2. 点击右上角"进入管理后台"
3. 点击左侧菜单"每日一题"
4. 点击"新建题目"按钮
5. 填写题目信息：
   - 题目内容: "测试草稿题目 - 黑先"
   - 难度: 选择"中级"
   - 标签: "手筋,官子"
   - 正确答案: "A1"
   - 棋谱数据: 可以留空或填写简单的SGF
6. **不要勾选**"推送到学生"
7. 点击"保存为草稿"按钮

**预期结果**:
- ✅ 显示"草稿保存成功"提示
- ✅ 页面刷新，草稿箱区域出现新草稿
- ✅ 草稿卡片显示黄色/橙色标识
- ✅ 草稿卡片显示"草稿"徽章
- ✅ 草稿不会出现在"已发布题目"列表中

**验证点**:
- [ ] 草稿创建成功
- [ ] 草稿箱显示正确
- [ ] 草稿标识清晰
- [ ] 草稿与已发布题目分离显示

#### 1.2 编辑草稿
**步骤**:
1. 在草稿箱中找到刚创建的草稿
2. 点击"编辑"按钮
3. 修改题目内容，例如添加 " - 更新版"
4. 再次点击"保存为草稿"

**预期结果**:
- ✅ 编辑表单正确加载草稿内容
- ✅ 修改保存成功
- ✅ 草稿箱中显示更新后的内容
- ✅ 草稿仍然保持草稿状态（isDraft = true）

**验证点**:
- [ ] 可以编辑草稿
- [ ] 草稿内容更新成功
- [ ] 草稿状态保持不变

#### 1.3 将草稿发布为正式题目
**步骤**:
1. 编辑一个草稿
2. 设置日期为今天或未来日期
3. 勾选"推送到学生"
4. 选择班级和学生
5. 设置截止时间
6. 点击"发布题目"

**预期结果**:
- ✅ 草稿从草稿箱移除
- ✅ 题目出现在"已发布题目"列表
- ✅ 显示蓝色/绿色已发布标识
- ✅ 推送记录已创建

**验证点**:
- [ ] 草稿成功发布
- [ ] 草稿箱不再显示该题目
- [ ] 已发布列表显示该题目
- [ ] 推送功能正常工作

---

### ✅ 2. 发布推送功能测试

#### 2.1 基本推送功能
**步骤**:
1. 创建新题目或编辑现有题目
2. 填写题目基本信息
3. 勾选"推送到学生"复选框

**预期结果**:
- ✅ 显示推送选项面板
- ✅ 显示班级选择下拉框
- ✅ 显示学生选择区域（初始为空）
- ✅ 显示截止时间选择器

**验证点**:
- [ ] 推送面板正确显示
- [ ] 控件状态正确

#### 2.2 选择推送目标
**步骤**:
1. 点击"选择班级"下拉框
2. 选择一个或多个班级
3. 观察学生列表的变化
4. 在学生列表中选择具体学生

**预期结果**:
- ✅ 班级列表正确加载
- ✅ 选择班级后，学生列表自动填充该班级的学生
- ✅ 可以选择/取消选择学生
- ✅ 显示已选择学生数量

**验证点**:
- [ ] 班级数据正确加载
- [ ] 学生数据根据班级正确筛选
- [ ] 多选功能正常

#### 2.3 设置推送时间
**步骤**:
1. 点击截止时间输入框
2. 选择未来的日期和时间（例如：明天 18:00）
3. 确认时间设置

**预期结果**:
- ✅ 日期时间选择器正常工作
- ✅ 可以选择未来时间
- ✅ 时间显示格式正确

**验证点**:
- [ ] 时间选择器正常
- [ ] 可以设置未来时间

#### 2.4 执行推送
**步骤**:
1. 确认所有推送信息已填写
2. 点击"发布题目"按钮
3. 等待服务器响应

**预期结果**:
- ✅ 显示"题目发布成功"提示
- ✅ 显示推送记录创建数量（例如："已推送给 3 名学生"）
- ✅ 页面刷新或跳转
- ✅ 题目出现在已发布列表

**验证点**:
- [ ] 发布成功
- [ ] 推送记录创建
- [ ] 提示信息准确

#### 2.5 验证推送记录（后端数据）
**检查数据库**:
```sql
-- 检查 ProblemPush 表
SELECT * FROM "ProblemPush" 
WHERE "problemId" = [新题目ID] 
ORDER BY "pushedAt" DESC;
```

**预期结果**:
- ✅ 为每个选中的学生创建一条推送记录
- ✅ status = 'ACTIVE'
- ✅ dueAt 为设置的截止时间
- ✅ pushedAt 为当前时间

**验证点**:
- [ ] 推送记录正确创建
- [ ] 数据完整性

---

### ✅ 3. 题目列表展示测试

#### 3.1 列表布局检查
**步骤**:
1. 进入"每日一题"管理页面
2. 观察页面布局

**预期结果**:
- ✅ 页面分为两个主要区域：
  - 草稿箱（Draft Box）
  - 已发布题目（Published Problems）
- ✅ 每个区域有标题和题目数量统计
- ✅ 每个区域有展开/收起功能
- ✅ 有"新建题目"按钮

**验证点**:
- [ ] 布局清晰分离
- [ ] 标题显示正确
- [ ] 统计数字准确

#### 3.2 草稿箱展示
**预期结果**:
- ✅ 草稿题目显示在草稿箱区域
- ✅ 草稿卡片有独特的视觉标识（黄色/橙色边框或背景）
- ✅ 显示"草稿"徽章
- ✅ 显示题目内容、难度、标签
- ✅ 显示创建时间
- ✅ 有"编辑"和"删除"按钮

**验证点**:
- [ ] 草稿正确显示
- [ ] 视觉区分明确
- [ ] 操作按钮可用

#### 3.3 已发布题目展示
**预期结果**:
- ✅ 已发布题目显示在已发布区域
- ✅ 已发布卡片有独特的视觉标识（蓝色/绿色边框）
- ✅ 显示"已发布"徽章
- ✅ 显示题目日期
- ✅ 显示推送统计（如果有推送）
- ✅ 有"编辑"、"查看提交"等按钮

**验证点**:
- [ ] 已发布题目正确显示
- [ ] 状态标识清晰
- [ ] 推送信息准确

#### 3.4 展开/收起功能
**步骤**:
1. 点击草稿箱标题旁的展开/收起图标
2. 点击已发布题目标题旁的展开/收起图标

**预期结果**:
- ✅ 点击后区域内容显示/隐藏
- ✅ 图标状态改变（向下箭头 ↔ 向右箭头）
- ✅ 动画流畅

**验证点**:
- [ ] 展开/收起功能正常
- [ ] 图标状态同步
- [ ] 用户体验良好

#### 3.5 题目排序
**预期结果**:
- ✅ 草稿按创建时间倒序排列（最新在前）
- ✅ 已发布题目按日期倒序排列（最新在前）

**验证点**:
- [ ] 排序逻辑正确

---

### ✅ 4. 公共主页功能测试

#### 4.1 访问公共主页
**步骤**:
1. 点击右上角用户菜单
2. 点击"我的主页"链接
3. 或直接访问 `/u/[用户ID]`

**预期结果**:
- ✅ 成功跳转到公共主页
- ✅ 页面布局美观
- ✅ 显示用户头像（首字母）
- ✅ 显示用户名
- ✅ 显示角色徽章（超级管理员/教练/学生）

**验证点**:
- [ ] 页面可访问
- [ ] 基本信息显示正确

#### 4.2 统计数据展示
**预期结果**:
- ✅ 显示三个主要统计卡片：
  1. **总提交数** - 显示数字 + Target 图标
  2. **正确率** - 显示百分比 + Award 图标
  3. **连续打卡** - 显示天数 + TrendingUp 图标
- ✅ 数据来自后端API
- ✅ 样式美观（卡片阴影、图标颜色）

**验证点**:
- [ ] 统计卡片显示
- [ ] 数据准确
- [ ] 样式正确

#### 4.3 出题历史展示（教练/管理员）
**预期结果**:
- ✅ 显示"出题历史"区域
- ✅ **只显示已发布的题目**（isDraft = false）
- ✅ **不显示草稿题目**
- ✅ 每个题目显示：
  - 题目内容
  - 发布日期
  - 提交次数统计
- ✅ 显示题目总数统计
- ✅ 如果是超级管理员，显示学生总数

**关键验证点**:
- [ ] ❗ 草稿题目不在列表中
- [ ] ❗ 只显示 isDraft = false 的题目
- [ ] 题目内容正确
- [ ] 统计数据准确

#### 4.4 最近练习记录（学生）
**如果以学生身份访问**:
- ✅ 显示"最近练习记录"区域
- ✅ 显示最近的提交记录
- ✅ 显示状态图标（✓ 正确 / ✗ 错误 / ○ 待批改）

**验证点**:
- [ ] 学生视图正确

#### 4.5 隐私保护验证
**步骤**:
1. 确保有多个草稿题目和已发布题目
2. 访问公共主页
3. 仔细检查出题历史列表

**预期结果**:
- ✅ 草稿题目完全不可见
- ✅ 只有已发布题目显示
- ✅ 题目内容不泄露敏感信息

**验证点**:
- [ ] ❗ 隐私保护生效
- [ ] ❗ 草稿不公开

---

### ✅ 5. 权限验证测试

#### 5.1 草稿访问权限
**测试场景**:
1. 创建一个草稿题目
2. 记录草稿的ID
3. 尝试访问 `/problem/[草稿ID]`（学生页面）

**预期结果**:
- ✅ 学生无法访问草稿题目
- ✅ 返回404或权限错误
- ✅ 或者草稿不会被推送，学生根本看不到

**验证点**:
- [ ] 草稿不可公开访问
- [ ] 权限控制正确

#### 5.2 API权限验证
**测试场景**:
```bash
# 尝试获取包含草稿的题目列表
curl http://localhost:3000/api/problems?includeDrafts=true
```

**预期结果**:
- ✅ 普通学生获取不到草稿
- ✅ 教练/管理员可以获取草稿（如果API支持）

**验证点**:
- [ ] API权限正确

#### 5.3 公共主页数据过滤
**验证SQL查询**:
- 检查 `/api/users/[id]/profile` 的实现
- 确认查询条件包含 `isDraft: false`

**验证点**:
- [ ] 后端正确过滤草稿

---

## 测试数据准备

### 创建测试数据
```javascript
// 如果需要批量创建测试数据，可以使用以下脚本

// 1. 创建 3 个草稿题目
// 2. 创建 5 个已发布题目
// 3. 其中 2 个已发布题目有推送记录
```

---

## 常见问题排查

### 问题1: 草稿不显示
**检查项**:
- [ ] 数据库中 `isDraft` 字段是否为 `true`
- [ ] 前端查询是否正确筛选草稿
- [ ] 是否有JavaScript错误

### 问题2: 推送失败
**检查项**:
- [ ] 班级和学生数据是否存在
- [ ] 截止时间格式是否正确
- [ ] 后端API是否正常工作
- [ ] 数据库外键约束是否满足

### 问题3: 公共主页显示草稿
**检查项**:
- [ ] API查询是否包含 `isDraft: false` 条件
- [ ] 前端是否正确过滤数据
- [ ] 缓存是否需要清除

### 问题4: 推送选项不显示
**检查项**:
- [ ] "推送到学生"复选框是否被勾选
- [ ] JavaScript事件绑定是否正常
- [ ] 班级数据是否加载

---

## 测试结果记录

### 测试执行日期: ___________
### 测试人员: ___________

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1.1 创建草稿 | ⬜ 通过 / ⬜ 失败 | |
| 1.2 编辑草稿 | ⬜ 通过 / ⬜ 失败 | |
| 1.3 发布草稿 | ⬜ 通过 / ⬜ 失败 | |
| 2.1 基本推送 | ⬜ 通过 / ⬜ 失败 | |
| 2.2 选择目标 | ⬜ 通过 / ⬜ 失败 | |
| 2.3 设置时间 | ⬜ 通过 / ⬜ 失败 | |
| 2.4 执行推送 | ⬜ 通过 / ⬜ 失败 | |
| 2.5 验证记录 | ⬜ 通过 / ⬜ 失败 | |
| 3.1 列表布局 | ⬜ 通过 / ⬜ 失败 | |
| 3.2 草稿箱 | ⬜ 通过 / ⬜ 失败 | |
| 3.3 已发布 | ⬜ 通过 / ⬜ 失败 | |
| 3.4 展开收起 | ⬜ 通过 / ⬜ 失败 | |
| 3.5 排序 | ⬜ 通过 / ⬜ 失败 | |
| 4.1 访问主页 | ⬜ 通过 / ⬜ 失败 | |
| 4.2 统计数据 | ⬜ 通过 / ⬜ 失败 | |
| 4.3 出题历史 | ⬜ 通过 / ⬜ 失败 | ❗ 关键 |
| 4.4 练习记录 | ⬜ 通过 / ⬜ 失败 | |
| 4.5 隐私保护 | ⬜ 通过 / ⬜ 失败 | ❗ 关键 |
| 5.1 草稿权限 | ⬜ 通过 / ⬜ 失败 | |
| 5.2 API权限 | ⬜ 通过 / ⬜ 失败 | |
| 5.3 数据过滤 | ⬜ 通过 / ⬜ 失败 | ❗ 关键 |

---

## 截图记录

请在测试时截图保存以下界面：

1. 📸 草稿箱显示多个草稿
2. 📸 推送设置界面（已选择班级和学生）
3. 📸 题目列表完整视图（草稿+已发布）
4. 📸 公共主页完整界面（包含出题历史）
5. 📸 出题历史详细列表（确认无草稿）

---

## 下一步行动

测试完成后：
- [ ] 记录所有发现的问题
- [ ] 创建 GitHub Issues
- [ ] 更新测试文档
- [ ] 准备修复计划
